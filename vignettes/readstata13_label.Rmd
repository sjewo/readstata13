---
title: "readstata13: working with labelled data"
author: "Sebastian Jeworutzki"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{readstata13_label}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(readstata13)
dir.create("res")
options(rmarkdown.html_vignette.check_title = FALSE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## How label are stored

Stata datasets inherit some meta data like variable or value labels. As base-R doesn't provide support for labelled data these information is stored in different attributes of the data.frame returned by `read.stata13`. These data.frames have equal attributes as data.frames from function `read.dta` from the `foreign` package.

For this example we use the Stata file "statacar.dta" provided with the package `readstata13`. We disable conversion of factors and start with numeric codes for categorical data.
```{r}
library(readstata13)
x <- read.dta13(system.file("extdata/statacar.dta", package = "readstata13"),
                convert.factors = FALSE)
```

Variable labels are stored in the `var.labels` attribute.
```{r}
attr(x, "var.labels")
```
Labels for a single variable might be retrieved by the `varlabel()` function.
```{r}
varlabel(x, var.name = "type")
# TODO: this will fail if number of columns in x has changed
```

The information about value labels is stored in a more complex way. The attribute `val.labels` defines for every columns a so called label table, which provides the codes and labels for a single variable. These label tables are stored as list in the attribute `label.table`.

The example dataset has only one column with labelled values.
```{r}
attr(x, "val.labels")
```
The corresponding label table for the fourth columns is called `type_en`. This is a vector of numeric codes and the labels are provides by element names.

```{r}
attr(x, "label.table")$type_en
```
The function `get.label.name()` and `get.label()` will provide the same results.
```{r}
get.label.name(x, var.name = "type")
get.label(x, "type_en")
```

Most often labels are used to create the levels of a factor variable. `readstata13` provides a command to make this process more easy. `set.lable()` returns a factor using the stored labels.

```{r}
# create factor from variable "type"
x$type_en <- set.label(x, "type")

# display results
x[, c("type", "type_en")]
```

As Stata supports multi-language files, labels might be provided for different languages. The option `lang` in `set.lable()` allows to choose labels for a specific language.

```{r}
# Show available and default language 
get.lang(x)

# create factor with German labels
x$type_de <- set.label(x, "type", lang = "de")

# display results
x[, c("type", "type_en", "type_de")]
```



## Compability with other packages

```{r, eval = packageVersion("labelled")>"2.8.0"}
# version > 2.8.0 is needed due to a bug in to_label
library(labelled)

xl <- read.dta13(system.file("extdata/statacar.dta", package = "readstata13"),
                convert.factors = FALSE)

xl <- to_labelled(xl)
xl
```

Packages like `expss` use the stored labels to produce descriptive headers in tables or to label the axis of a graph.

```{r, eval = packageVersion("labelled")>"2.8.0"}
library(expss)
#xl <- add_labelled_class(xl) 

# set negative hp values to na
xl[xl$hp < 0 | is.na(xl$hp), "hp"] <- NA

xl %>% 
  tab_cells(hp) %>% 
  tab_cols(brand) %>% 
  tab_stat_mean_sd_n() %>% 
  tab_pivot() %>%
  set_caption("Horse power by car brand.")

```

